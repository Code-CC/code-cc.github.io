<!DOCTYPE html>
<html>
  <head>
    <title>理解系统启动过程</title>
    <meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<meta http-equiv="X-UA-Compatible" content="ie=edge" />


<link rel="stylesheet" href="/assets/css/bootstrap.min.css" />
<link rel="stylesheet" href="/assets/css/style.css" />
<link rel="stylesheet" href="/assets/css/navbar.css" />


<link href="https://fonts.googleapis.com/css?family=Muli" rel="stylesheet" />
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.11.2/css/all.min.css" />


<link rel="icon" type="image/png" href="/assets/images/favicon.png" />


    
<link
  rel="stylesheet"
  href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.18.1/styles/atom-one-dark.min.css"
/>
<link rel="stylesheet" href="/assets/css/single.css" />


    
    
      
<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
	ga('create', '\u003cyour google analytics id\u003e', 'auto');
	
	ga('send', 'pageview');
}
</script>
<script async src='https://www.google-analytics.com/analytics.js'></script>

    
  </head>

  <body>
    <div class="container-fluid bg-dimmed wrapper">
      
      
    <nav class="navbar navbar-expand-lg top-navbar final-navbar shadow">
    <div class="container">
      <a class="navbar-brand" href="https://cctrip.github.io/">
        <img src="/assets/images/logo.png">CC&#39;s Trip</a>
      <button class="navbar-toggler navbar-light" type="button" >
        <span class="navbar-toggler-icon"></span>
      </button>

      <div class="collapse navbar-collapse" id="top-nav-items">
        <ul class="navbar-nav ml-auto">
        </ul>
        </ul>
      </div>
    </div>
</nav>



      
      
<div class="container p-0 read-area">
  
  <div class="hero-area col-sm-12" style='background-image: url(/images/posts/linux.jpg);'>
  </div>

  
  <div class="page-content">
    <div class="author-profile ml-auto align-self-lg-center">
      <img class="rounded-circle" src='/images/cc.jpg'/>
      <h5 class="author-name">Hello.CC</h5>
      <p>May 21, 2016</p>
    </div>

    <div class="title">
      <h1>理解系统启动过程</h1>
    </div>

    <div class="post-content">
      <h3 id="前言">前言</h3>
<p>Linux是一种自由和开放源代码的类UNIX操作系统。该操作系统的内核由林纳斯·托瓦兹在1991年10月5日首次发布。在加上用户空间的应用程序之后，成为Linux操作系统。Linux是自由软件和开放源代码软件发展中最著名的例子。</p>
<p>接触Linux的时间也不算短了，一直都是直接使用Linux操作系统进行一些工作，很少去了解系统从开机到能使用的整个过程，感觉有需要好好理解下整个系统的启动过程，故写这篇博客加深一下理解。</p>
<hr>
<h3 id="启动过程">启动过程</h3>
<p>先通过一张图来简单了解下整个系统启动的流程，整个过程基本可以分为<font color=blue>POST&ndash;&gt;BIOS&ndash;&gt;MBR(GRUB)&ndash;&gt;Kernel&ndash;&gt;Init&ndash;&gt;Runlevel</font>。下面会详细说明每个过程的作用。</p>
<p><img src="image/607348-20151229231206354-919070678.png" alt=""></p>
<ul>
<li>
<p>BIOS</p>
<p>BIOS(Basic Input/Output System)，基本输入输出系统，该系统存储于主板的ROM芯片上，计算机在开机时，会最先读取该系统，然后会有一个加电自检过程，这个过程其实就是检查CPU和内存，计算机最基本的组成单元(控制器、运算器和存储器)，还会检查其他硬件，若没有异常就开始加载BIOS程序到内存当中。详细的BIOS功能，这边就不说了，BIOS主要的一个功能就是存储了磁盘的启动顺序，BIOS会按照启动顺序去查找第一个磁盘头的MBR信息，并加载和执行MBR中的Bootloader程序，若第一个磁盘不存在MBR，则会继续查找第二个磁盘(PS：启动顺序可以在BIOS的界面中进行设置)，一旦BootLoader程序被检测并加载内存中，BIOS就将控制权交接给了BootLoader程序。</p>
</li>
<li>
<p>MBR</p>
<p>MBR(Master Boot Record)，主引导记录，MBR存储于磁盘的头部，大小为512bytes，其中，446bytes用于存储BootLoader程序，64bytes用于存储分区表信息，最后2bytes用于MBR的有效性检查。</p>
</li>
<li>
<p>GRUB</p>
<p>GRUB(Grand Unified Bootloader)，多系统启动程序，其执行过程可分为三个步骤：</p>
<ul>
<li>
<p>Stage1：这个其实就是MBR，它的主要工作就是查找并加载第二段Bootloader程序(stage2)，但系统在没启动时，MBR根本找不到文件系统，也就找不到stage2所存放的位置，因此，就有了stage1_5</p>
</li>
<li>
<p>Stage1_5：该步骤就是为了识别文件系统</p>
</li>
<li>
<p>Stage2：GRUB程序会根据/boot/grub/grub.conf文件查找Kernel的信息，然后开始加载Kernel程序，当Kernel程序被检测并在加载到内存中，GRUB就将控制权交接给了Kernel程序。</p>
<p>PS：实际上这个步骤/boot还没被挂载，GRUB直接识别grub所在磁盘的文件系统，所以实际上应该是/grub/grub.conf文件，该配置文件的信息如下：</p>
<p>grub.conf:</p>
</li>
</ul>
<pre><code>  
</code></pre><pre><code></code></pre></li>
</ul>
<p>#boot=/dev/sda</p>
<p>default=0    #设定默认启动的title的编号，从0开始</p>
<p>timeout=5    #等待用户选择的超时时间</p>
<p>splashimage=(hd0,0)/boot/grub/splash.xpm.gz  #GRUB的背景图片</p>
<p>hiddenmenu   #隐藏菜单</p>
<p>title CentOS (2.6.18-194.el5PAE)    #内核标题</p>
<pre><code>root (hd0,0)       #内核文件所在的设备

kernel /vmlinuz-2.6.18-194.el5PAE ro root=LABEL=/   #内核文件路径以及传递给内核的参数

initrd /initrd-2.6.18-194.el5PAE.img                #ramdisk文件路径
```
</code></pre>
<ul>
<li>
<p>Kernel</p>
<p>Kernel，内核，Kernel是Linux系统最主要的程序，实际上，Kernel的文件很小，只保留了最基本的模块，并以压缩的文件形式存储在硬盘中，当GRUB将Kernel读进内存，内存开始解压缩内核文件。讲内核启动，应该先讲下initrd这个文件，</p>
<p>initrd(Initial RAM Disk)，它在stage2这个步骤就被拷贝到了内存中，这个文件是在安装系统时产生的，是一个临时的根文件系统(rootfs)。因为Kernel为了精简，只保留了最基本的模块，因此，Kernel上并没有各种硬件的驱动程序，也就无法识rootfs所在的设备，故产生了initrd这个文件，该文件装载了必要的驱动模块，当Kernel启动时，可以从initrd文件中装载驱动模块，直到挂载真正的rootfs，然后将initrd从内存中移除。</p>
<p>Kernel会以只读方式挂载根文件系统，当根文件系统被挂载后，开始装载第一个进程(用户空间的进程)，执行/sbin/init，之后就将控制权交接给了init程序。</p>
</li>
<li>
<p>Init</p>
<p>init，初始化，顾名思义，该程序就是进行OS初始化操作，实际上是根据/etc/inittab(定义了系统默认运行级别)设定的动作进行脚本的执行，第一个被执行的脚本为/etc/rc.d/rc.sysinit，这个是真正的OS初始化脚本，简单讲下这个脚本的任务(可以去看看实际脚本，看看都做了什么)：</p>
<ul>
<li>激活udev和selinux;</li>
<li>根据/etc/sysctl.conf文件，来设定内核参数;</li>
<li>设定系统时钟;</li>
<li>装载硬盘映射;</li>
<li>启用交换分区;</li>
<li>设置主机名;</li>
<li>根文件系统检测，并以读写方式重新挂载根文件系统;</li>
<li>激活RAID和LVM设备;</li>
<li>启用磁盘配额;</li>
<li>根据/etc/fstab，检查并挂载其他文件系统;</li>
<li>清理过期的锁和PID文件</li>
</ul>
<p>执行完后，根据配置的启动级别，执行对应目录底下的脚本，最后执行/etc/rc.d/rc.local这个脚本，至此，系统启动完成。</p>
</li>
<li>
<p>Runlevel</p>
<p>runlevel，运行级别，不同的级别会启动的服务不一样，init会根据定义的级别去执行相应目录下的脚本，Linux的启动级别分为以下几种：</p>
<p>0：关机模式</p>
<p>1：单一用户模式(直接以管理员身份进入)</p>
<p>2：多用户模式（无网络）</p>
<p>3：多用户模式（命令行）</p>
<p>4：保留</p>
<p>5：多用户模式（图形界面）</p>
<p>6：重启</p>
<p>在不同的运行级别下，/etc/rc.d/rc这个脚本会分别执行不同目录下的脚本：</p>
<p>Runlevel 0 – /etc/rc.d/rc0.d/</p>
<p>Runlevel 1 – /etc/rc.d/rc1.d/</p>
<p>Runlevel 2 – /etc/rc.d/rc2.d/</p>
<p>Runlevel 3 – /etc/rc.d/rc3.d/</p>
<p>Runlevel 4 – /etc/rc.d/rc4.d/</p>
<p>Runlevel 5 – /etc/rc.d/rc5.d/</p>
<p>Runlevel 6 – /etc/rc.d/rc6.d/</p>
<p>这些目录下的脚本只有K*和S*开头的文件，K开头的文件为开机需要执行关闭的服务，S开头的文件为开机需要执行开启的服务。</p>
</li>
</ul>
<hr>
<h3 id="参考">参考</h3>
<p><a href="http://www.thegeekstuff.com/2011/02/linux-boot-process/">http://www.thegeekstuff.com/2011/02/linux-boot-process/</a></p>
<p><a href="http://www.ibm.com/developerworks/library/l-linuxboot/">http://www.ibm.com/developerworks/library/l-linuxboot/</a></p>

    </div>

    
    
      <div class="btn-improve-page">
          <a href="%3cyour%20site%27s%20Github%20repo%20URL%3e/edit/master/content/posts/systemstart.md">
            <i class="fas fa-code-branch"></i>
            Improve This Page
          </a>
      </div>
    

    
  <hr />
  <div class="row next-prev-navigator">
    
    
      
    
      
    
      
        
        <div class="col-md-6 previous-article">
          <a href="/posts/http/" class="btn btn-outline-info">
            <span><i class="fas fa-chevron-circle-left"></i> Prev</span>
            <br />
            <span>谈谈HTTP</span>
          </a>
        </div>
        
        
        <div class="col-md-6 next-article">
          <a href="/posts/dns/" class="btn btn-outline-info">
            <span>Next <i class="fas fa-chevron-circle-right"></i></span>
            <br />
            <span>谈谈DNS</span>
          </a>
        </div>
        
      
    
      
    
      
    
      
    
      
    
      
    
      
    
  </div>
  <hr />
  
  
      <div id="disqus_thread"></div>
<script type="text/javascript">
  (function () {
    
    
    if (window.location.hostname == "localhost") return;

    var dsq = document.createElement("script");
    dsq.type = "text/javascript";
    dsq.async = true;
    var disqus_shortname = "\u003cyour disqus short code\u003e";
    dsq.src = "//" + disqus_shortname + ".disqus.com/embed.js";
    (
      document.getElementsByTagName("head")[0] ||
      document.getElementsByTagName("body")[0]
    ).appendChild(dsq);
  })();
</script>
<noscript
  >Please enable JavaScript to view the
  <a href="https://disqus.com/?ref_noscript"
    >comments powered by Disqus.</a
  ></noscript
>
<a href="https://disqus.com/" class="dsq-brlink"
  >comments powered by <span class="logo-disqus">Disqus</span></a
>

  
</div>

    </div>

    <footer class="container-fluid text-center align-content-center footer pb-2">
  <div class="container pt-5">
    <div class="row text-left">
      <div class="col-md-4 col-sm-12">
        <h5>Navigation</h5>
        
          <ul>
            
            <li class="nav-item">
              <a class="smooth-scroll" href="#home">Home</a>
            </li>
            
            <li class="nav-item">
              <a class="smooth-scroll" href="#about">About</a>
            </li>
            
            <li class="nav-item">
              <a class="smooth-scroll" href="#skills">Skills</a>
            </li>
            
            <li class="nav-item">
              <a class="smooth-scroll" href="#experiences">Experiences</a>
            </li>
            
            <li class="nav-item">
              <a class="smooth-scroll" href="#projects">Projects</a>
            </li>
            
            <li class="nav-item">
              <a class="smooth-scroll" href="#recent-posts">Recent Posts</a>
            </li>
            
          </ul>
        
      </div>
      <div class="col-md-4 col-sm-12">
        <h5>Contact Me</h5>
        <ul>
          
          <li><span>Email: </span> <span>zcc0388@gmail.com</span></li>
          
          <li><span>WeChat: </span> <span>zcc0388</span></li>
          
        </ul>
      </div>
      <div class="col-md-4 col-sm-12">
        
        <p>Stay up to date with email notification</p>
        <form>
          <div class="form-group">
            <input
              type="email"
              class="form-control"
              id="exampleInputEmail1"
              aria-describedby="emailHelp"
              placeholder="Enter email"
            />
            <small id="emailHelp" class="form-text text-muted"
              >We'll never share your email with anyone else.</small
            >
          </div>
          <button type="submit" class="btn btn-info">Submit</button>
        </form>
      </div>
    </div>
  </div>
  <hr />
  <div class="container">
    <div class="row text-left">
      <div class="col-md-4">
        <a id="theme" href="https://github.com/hossainemruz/toha" target="#">
          <img src="/assets/images/logo-inverted.png">
          Toha
        </a>
      </div>
      <div class="col-md-4">© 2019 Copyright.</div>
      <div class="col-md-4">
        Powered by <a href="https://gohugo.io/">Hugo
        <img
          src="/assets/images/hugo-logo-wide.svg"
          alt="Hugo Logo"
          height="18"
        />
        </a>
      </div>
    </div>
  </div>
</footer>

    <script src="/assets/js/jquery-3.4.1.min.js"></script>
<script src="/assets/js/bootstrap.min.js"></script>

<script src="/assets/js/navbar.js"></script>
<script src="/assets/js/jquery.filterizr.min.js"></script>


    
    
<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.18.1/highlight.min.js"></script>
<script src="/assets/js/single.js"></script>
<script>
  hljs.initHighlightingOnLoad();
</script>


  </body>
</html>
