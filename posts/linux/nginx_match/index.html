<!DOCTYPE html>
<html>
  <head>
    <title>Nginx匹配机制总结</title>
    <meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<meta http-equiv="X-UA-Compatible" content="ie=edge" />


<link rel="stylesheet" href="/assets/css/bootstrap.min.css" />
<link rel="stylesheet" href="/assets/css/layouts/main.css" />
<link rel="stylesheet" href="/assets/css/style.css" />
<link rel="stylesheet" href="/assets/css/navigators/navbar.css" />


<link href="https://fonts.googleapis.com/css2?family=Muli:wght@300;400;500;600" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.11.2/css/all.min.css" />


<link rel="icon" type="image/png" href="/assets/images/favicon.png" />


<link rel="stylesheet" href="/assets/css/style.css" />

    
<meta name="description" content="Nginx匹配机制总结" />
<link
  rel="stylesheet"
  href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.18.1/styles/atom-one-dark.min.css"
/>
<link rel="stylesheet" href="/assets/css/layouts/single.css" />
<link rel="stylesheet" href="/assets/css/navigators/sidebar.css">


    
    
      
<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
	ga('create', '\u003cyour google analytics id\u003e', 'auto');
	
	ga('send', 'pageview');
}
</script>
<script async src='https://www.google-analytics.com/analytics.js'></script>

    
  </head>

  <body data-spy="scroll" data-target="#TableOfContents" data-offset="80">
    <div class="container-fluid bg-dimmed wrapper">
      
      
    <nav class="navbar navbar-expand-xl top-navbar final-navbar shadow">
  <div class="container">
    
    
    
    
      <button class="navbar-toggler navbar-light" id="sidebar-toggler" type="button" onclick="toggleSidebar()">
      <span class="navbar-toggler-icon"></span>
    </button>
    <a class="navbar-brand" href="https://cctrip.github.io/">
      <img src="/assets/images/main-logo.png">CC&#39;s Trip</a>
    <button class="navbar-toggler navbar-light" id="toc-toggler" type="button" onclick="toggleTOC()">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div class="collapse navbar-collapse" id="top-nav-items">
      <ul class="navbar-nav ml-auto">
      </ul>
    </div>
  </div>
  
  <img src="/assets/images/main-logo.png" class="d-none" id="main-logo">
  <img src="/assets/images/inverted-logo.png" class="d-none" id="inverted-logo">
</nav>



      
      
  <section class="sidebar-section" id="sidebar-section">
    <div class="sidebar-holder">
      <div class="sidebar" id="sidebar">
        <input type="text" value="" placeholder="Search" data-search="" id="search-box" />
        <div class="sidebar-tree">
          <ul class="tree" id="tree">
            <li id="list-heading"><a href="/posts" data-filter="all">Posts</a></li>
            <div class="subtree">
                
  
  
  
  
    
    
  
  
    
    <li>
      <i class="fas fa-minus-circle"></i><a class="active" href="/posts/linux/">Linux</a>
      
      <ul class="active">
        
  
  
  
  
  
    
    <li><a class="" href="/posts/linux/linux_pam/">Linux pam模块</a></li>
  

  
  
  
  
    
    
  
  
    
    <li><a class="active" href="/posts/linux/nginx_match/">Nginx匹配机制总结</a></li>
  

  
  
  
  
  
    
    <li><a class="" href="/posts/linux/system_start/">理解系统启动过程</a></li>
  

  
  
  
  
  
    
    <li><a class="" href="/posts/linux/file_descriptor/">谈谈文件描述符</a></li>
  


      </ul>
    </li>
  

  
  
  
  
  
    
    <li>
      <i class="fas fa-plus-circle"></i><a class="" href="/posts/network/">Network</a>
      
      <ul class="">
        
  
  
  
  
  
    
    <li><a class="" href="/posts/network/network_comm/">初识网络通信</a></li>
  

  
  
  
  
  
    
    <li><a class="" href="/posts/network/dns/">谈谈DNS</a></li>
  

  
  
  
  
  
    
    <li><a class="" href="/posts/network/http/">谈谈HTTP</a></li>
  


      </ul>
    </li>
  

  
  
  
  
  
    
    <li>
      <i class="fas fa-plus-circle"></i><a class="" href="/posts/security/">Security</a>
      
      <ul class="">
        
  
  
  
  
  
    
    <li><a class="" href="/posts/security/webcsp/">WEB安全之CSP</a></li>
  

  
  
  
  
  
    
    <li><a class="" href="/posts/security/tls/">理解SSL/TLS协议</a></li>
  


      </ul>
    </li>
  

  
  
  
  
  
    
    <li>
      <i class="fas fa-plus-circle"></i><a class="" href="/posts/devops/">DevOps</a>
      
      <ul class="">
        
  
  
  
  
  
    
    <li><a class="" href="/posts/devops/monitor/">SRE之监控系统</a></li>
  

  
  
  
  
  
    
    <li><a class="" href="/posts/devops/sre/">运维进阶之SRE</a></li>
  


      </ul>
    </li>
  

  
  
  
  
  
    
    <li><a class="" href="/posts/life/">Life</a></li>
  


            </div>
          </ul>
        </div>
      </div>
    </div>
  </section>


      
      
<section class="content-section" id="content-section">
  <div class="content">
    <div class="container p-0 read-area">
      
      <div class="hero-area col-sm-12" id="hero-area" style='background-image: url(https://cctrip.github.io/images/posts/nginx.png);'>
      </div>

      
      <div class="page-content">
        <div class="author-profile ml-auto align-self-lg-center">
          <img class="rounded-circle" src='/images/cc.jpg'/>
          <h5 class="author-name">Hello.CC</h5>
          <p>June 6, 2020</p>
        </div>

        <div class="title">
          <h1>Nginx匹配机制总结</h1>
        </div>

        <div class="post-content" id="post-content">
          <h3 id="写在前面">写在前面</h3>
<p>Nginx是一个当前主流的HTTP服务器和反向代理服务器，很多做WEB相关的同学基本都会用到，很多云厂商的七层负载均衡器也基本都是基于nginx实现的，个人在工作过程也算是经常接触，这篇文章主要想总结一下nginx的匹配机制，主要分为两块，一块是server的匹配，一块是location的匹配。</p>
<hr>
<h3 id="server匹配机制">Server匹配机制</h3>
<p>配置过nginx的都知道，在一个http模块中是可以配置多个server模块的，并且多个server模块是可以配置相同的监听端口的，下面是一个简单的server配置例子：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-nginx" data-lang="nginx"><span style="color:#66d9ef">server</span> {
    <span style="color:#f92672">listen</span>      <span style="color:#ae81ff">80</span>;
    <span style="color:#f92672">server_name</span> <span style="color:#e6db74">example.org</span> <span style="color:#e6db74">www.example.org</span>;
    <span style="color:#f92672">...</span>
<span style="color:#960050;background-color:#1e0010">}</span>

<span style="color:#e6db74">server</span> {
    <span style="color:#f92672">listen</span>      <span style="color:#ae81ff">80</span>;
    <span style="color:#f92672">server_name</span> <span style="color:#e6db74">example.net</span> <span style="color:#e6db74">www.example.net</span>;
    <span style="color:#f92672">...</span>
<span style="color:#960050;background-color:#1e0010">}</span>

<span style="color:#e6db74">server</span> {
    <span style="color:#f92672">listen</span>      <span style="color:#ae81ff">80</span>;
    <span style="color:#f92672">server_name</span> <span style="color:#e6db74">example.com</span> <span style="color:#e6db74">www.example.com</span>;
    <span style="color:#f92672">...</span>
<span style="color:#960050;background-color:#1e0010">}</span>
</code></pre></div><p>当我们对nginx发起http请求后，nginx会拿到http请求中对应的 <code>&quot;Host&quot;</code> 头部跟server模块中的<code>server_name</code>进行匹配，根据匹配的server结果进入具体的server模块处理http请求。那么，它具体的匹配机制是怎样的呢？</p>
<p>首先，我们先简单了解下nginx内部server的相关结构，</p>
<p>其中listen和server_name在配置文件中的写法有：</p>
<ul>
<li>listen(可带default_server标识)
<ul>
<li><code>ip:port</code></li>
<li><code>ip</code>(监听80端口)</li>
<li><code>port</code>(监听所有地址)</li>
</ul>
</li>
<li>server_name
<ul>
<li><code>www.example.com</code>(完整域名)</li>
<li><code>*.example.com(</code>带通配符开头的域名)</li>
<li><code>www.example.*</code>(带通配符结尾的域名)</li>
<li><code>~^(www.)?(.+)$</code>(正则写法的域名)</li>
</ul>
</li>
</ul>
<p>代码中的具体结构：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c"><span style="color:#75715e">/*************************************************************************************
</span><span style="color:#75715e">伪结构体示例
</span><span style="color:#75715e">(port) --&gt; address(ip:port) --&gt; server(example.com)
</span><span style="color:#75715e">                            --&gt; server(example.net)
</span><span style="color:#75715e">                           
</span><span style="color:#75715e">一个server模块的唯一标识是由address(listen配置)和server(server_name配置)组成
</span><span style="color:#75715e">*************************************************************************************/</span>

<span style="color:#75715e">/* address 结构体，具有相同的ip:port */</span>
<span style="color:#66d9ef">struct</span> ngx_http_addr_conf_s {
  <span style="color:#75715e">/* default_server
</span><span style="color:#75715e">  	 存储的是listen配置里带default_server标识的server，
</span><span style="color:#75715e">     若没有就为顺序中的第一个server */</span>
  ngx_http_core_srv_conf_t  <span style="color:#f92672">*</span>default_server;
  ngx_http_virtual_names_t  <span style="color:#f92672">*</span>virtual_names;
  <span style="color:#66d9ef">unsigned</span>                   ssl:<span style="color:#ae81ff">1</span>;
  <span style="color:#66d9ef">unsigned</span>                   http2:<span style="color:#ae81ff">1</span>;
  <span style="color:#66d9ef">unsigned</span>                   proxy_protocol:<span style="color:#ae81ff">1</span>;
};

<span style="color:#75715e">/* virtual_name结构体，存储hash_combined和正则写法的server_name */</span>
<span style="color:#66d9ef">typedef</span> <span style="color:#66d9ef">struct</span> {
  ngx_hash_combined_t        names;
  ngx_uint_t                 nregex;
  ngx_http_server_name_t    <span style="color:#f92672">*</span>regex;
} ngx_http_virtual_names_t;

<span style="color:#75715e">/* hash_combined结构体，存储完成域名、通配符开头、通配符结尾的server_name */</span>
<span style="color:#66d9ef">typedef</span> <span style="color:#66d9ef">struct</span> {
  ngx_hash_t            hash;
  ngx_hash_wildcard_t  <span style="color:#f92672">*</span>wc_head;
  ngx_hash_wildcard_t  <span style="color:#f92672">*</span>wc_tail;
} ngx_hash_combined_t;

</code></pre></div><p>通过结构体，我们来说明下server的匹配规则：</p>
<ol>
<li>host是否匹配virtual_names中的names中的完整域名(<code>hash</code>)，若是则返回</li>
<li>host是否匹配virtual_name中的names中的通配符开头的域名(<code>wc_head</code>)，若是则返回</li>
<li>host是否匹配virtual_name中的names中的通配符结尾的域名(<code>wc_tail</code>)，若是则返回</li>
<li>host是否匹配virtual_name中的正则写法的域名(<code>regex</code>)，若是则返回</li>
<li>返回<code>default_server</code></li>
</ol>
<p>具体示例如下：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-nginx" data-lang="nginx"><span style="color:#75715e">#精确匹配，第一优先级
</span><span style="color:#75715e"></span><span style="color:#66d9ef">server</span> {
  <span style="color:#f92672">listen</span> <span style="color:#ae81ff">80</span>;
  <span style="color:#f92672">server_name</span> <span style="color:#e6db74">www.test.com</span>;
}

<span style="color:#75715e">#通配符开头匹配，第二优先级，
</span><span style="color:#75715e"></span><span style="color:#66d9ef">server</span> {
  <span style="color:#f92672">listen</span> <span style="color:#ae81ff">80</span>;
  <span style="color:#f92672">server_name</span> <span style="color:#e6db74">*.test.com</span>;
}

<span style="color:#75715e">#通配符结尾匹配，第三优先级
</span><span style="color:#75715e"></span><span style="color:#66d9ef">server</span> {
  <span style="color:#f92672">listen</span> <span style="color:#ae81ff">80</span>;
  <span style="color:#f92672">server_name</span> <span style="color:#e6db74">www.test.*</span>;
}

<span style="color:#75715e">#正则匹配，第三优先级
</span><span style="color:#75715e"></span><span style="color:#66d9ef">server</span> {
  <span style="color:#f92672">listen</span> <span style="color:#ae81ff">80</span>;
  <span style="color:#f92672">server_name</span> ~<span style="color:#e6db74">^(www.)?(.+)$;</span>
<span style="color:#960050;background-color:#1e0010">}</span>


<span style="color:#75715e">#default，没找到对应host，则以此优先
</span><span style="color:#75715e"></span><span style="color:#e6db74">server</span> {
  <span style="color:#f92672">listen</span> <span style="color:#ae81ff">80</span> <span style="color:#e6db74">defalut_server</span>;
  <span style="color:#f92672">server_name</span> <span style="color:#e6db74">_</span>;
}

<span style="color:#75715e">#若没有加defalut_server，则第一个server为defalut_server
</span><span style="color:#75715e"></span><span style="color:#f92672">server</span> {
  <span style="color:#f92672">listen</span> <span style="color:#ae81ff">80</span>;
  <span style="color:#f92672">server_name</span> <span style="color:#e6db74">_</span>;
}
</code></pre></div><hr>
<h3 id="location匹配机制">Location匹配机制</h3>
<p>一个server模块可以配置多个location，nginx根据<code>URI</code>来进行匹配，</p>
<p>lication的写法有以下几种：</p>
<ol>
<li>
<p><code>= /uri</code> 精确匹配</p>
</li>
<li>
<p><code>^~ /uri</code> 非正则前缀匹配</p>
</li>
<li>
<p><code>~ 或者 ~* /uri</code> 正则匹配</p>
</li>
<li>
<p><code>/uri</code> 前缀匹配</p>
</li>
</ol>
<p>整个location匹配机制如下：</p>
<ol>
<li>针对所有前缀字符串测试URI(包括精确匹配、非正则前缀匹配、前缀匹配中的字符串)</li>
<li>uri等于精确匹配中的字符串，停止搜索</li>
<li>最长(最相似)前缀字符串如果为非正则前缀匹配(带<code>^~</code>)，则停止正则搜索</li>
<li>保存最长(最相似)的前缀字符串</li>
<li>按顺序进行uri和正则匹配测试，有一个匹配成功后就停止搜索</li>
<li>如果都没有，就使用最长(最相似)的前缀匹配</li>
</ol>
<h6 id="额外说明">额外说明：</h6>
<p>最长(最相似)前缀字符串的测试阶段，非正则前缀匹配匹配、前缀匹配的优先级是一致的，谁的长度长，谁优先。优先前缀匹配的前提必须是前缀字符串<code>非正则前缀匹配的长度</code>大于<code>前缀匹配的长度</code>，这个很多网站都是直接写成了非正则前缀匹配是第二优先级，没有说明前提条件。</p>
<p>具体示例如下：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-nginx" data-lang="nginx"><span style="color:#75715e">#精确匹配，第一优先级
</span><span style="color:#75715e"></span><span style="color:#66d9ef">location</span> = <span style="color:#e6db74">/test</span> {
  
}
<span style="color:#75715e">#前缀匹配，最低优先级，长度优先
</span><span style="color:#75715e"></span><span style="color:#66d9ef">location</span> <span style="color:#e6db74">/test/aa</span> {
  
}

<span style="color:#75715e">#非正则前缀匹配，最长前缀下为第二优先级(特殊条件下)
</span><span style="color:#75715e"></span><span style="color:#66d9ef">location</span> <span style="color:#e6db74">^~</span> <span style="color:#e6db74">/test</span> {
  
}

<span style="color:#75715e">#正则匹配，第三优先级,顺序优先
</span><span style="color:#75715e"># ~ : 区分大小写
</span><span style="color:#75715e"># ~* : 不区分大小写 
</span><span style="color:#75715e"></span><span style="color:#66d9ef">location</span> ~<span style="color:#e6db74">*</span> <span style="color:#e6db74">^/test</span> {
  
}
</code></pre></div><hr>
<h3 id="参考">参考</h3>
<p><a href="https://nginx.org/en/docs/http/request_processing.html">https://nginx.org/en/docs/http/request_processing.html</a></p>
<p><a href="https://nginx.org/en/docs/http/ngx_http_core_module.html#location">https://nginx.org/en/docs/http/ngx_http_core_module.html#location</a></p>
<p><a href="https://docs.nginx.com/nginx/admin-guide/web-server/web-server/">https://docs.nginx.com/nginx/admin-guide/web-server/web-server/</a></p>
<p><a href="https://www.codedump.info/post/20190212-nginx-http-config/">https://www.codedump.info/post/20190212-nginx-http-config/</a></p>

        </div>

        
        
          <div class="btn-improve-page">
              <a href="https://github.com/cctrip/blogs/edit/master/content/posts/linux/nginx_match.md">
                <i class="fas fa-code-branch"></i>
                Improve This Page
              </a>
          </div>
        

        
      <hr />
        <div class="row next-prev-navigator">


  

  

  

  

  

  

  

  

  

  
    
      
      <div class="col-md-6 previous-article">
        <a href="/posts/devops/sre/" class="btn btn-outline-info">
          <span><i class="fas fa-chevron-circle-left"></i> Prev</span>
          <br />
          <span>运维进阶之SRE</span>
        </a>
      </div>
      
    
    
      
        
        
          
              
          
        
        <div class="col-md-6 next-article">
          <a href="/posts/linux/linux_pam/" class="btn btn-outline-info">
            <span>Next <i class="fas fa-chevron-circle-right"></i></span>
            <br />
            <span>Linux pam模块</span>
          </a>
        </div>
      
    
  

  

  

</div>

      <hr />
      
      
          <div id="disqus_thread"></div>
<script type="text/javascript">
  (function () {
    
    
    if (window.location.hostname == "localhost") return;

    var dsq = document.createElement("script");
    dsq.type = "text/javascript";
    dsq.async = true;
    var disqus_shortname = "\u003cyour disqus short code\u003e";
    dsq.src = "//" + disqus_shortname + ".disqus.com/embed.js";
    (
      document.getElementsByTagName("head")[0] ||
      document.getElementsByTagName("body")[0]
    ).appendChild(dsq);
  })();
</script>
<noscript
  >Please enable JavaScript to view the
  <a href="https://disqus.com/?ref_noscript"
    >comments powered by Disqus.</a
  ></noscript
>
<a href="https://disqus.com/" class="dsq-brlink"
  >comments powered by <span class="logo-disqus">Disqus</span></a
>

      
      </div>
    </div>
  </div>
</section>


      
      
  <section class="toc-section" id="toc-section">
    
    <div class="toc-holder">
      <h5 class="text-center pl-3">Table of Contents</h5>
      <hr>
      <div class="toc">
        <nav id="TableOfContents">
  <ul>
    <li>
      <ul>
        <li><a href="#写在前面">写在前面</a></li>
        <li><a href="#server匹配机制">Server匹配机制</a></li>
        <li><a href="#location匹配机制">Location匹配机制</a>
          <ul>
            <li>
              <ul>
                <li></li>
              </ul>
            </li>
          </ul>
        </li>
        <li><a href="#参考">参考</a></li>
      </ul>
    </li>
  </ul>
</nav>
      </div>
    </div>
    
  </section>

    </div>

    <footer class="container-fluid text-center align-content-center footer pb-2">
  <div class="container pt-5">
    <div class="row text-left">
      <div class="col-md-4 col-sm-12">
        <h5>Navigation</h5>
        
        <ul>
            
            <li class="nav-item">
              <a class="smooth-scroll" href="/#about">About</a>
            </li>
            
            
            <li class="nav-item">
              <a class="smooth-scroll" href="/#skills">Skills</a>
            </li>
            
            
            <li class="nav-item">
              <a class="smooth-scroll" href="/#experiences">Experiences</a>
            </li>
            
            
            <li class="nav-item">
              <a class="smooth-scroll" href="/#projects">Projects</a>
            </li>
            
            
            <li class="nav-item">
              <a class="smooth-scroll" href="/#recent-posts">Recent Posts</a>
            </li>
            
        </ul>
        

      </div>
      <div class="col-md-4 col-sm-12">
        <h5>Contact Me</h5>
        <ul>
          
          <li><span>Email: </span> <span>zcc0388@gmail.com</span></li>
          
          <li><span>Wechat: </span> <span>zcc0388</span></li>
          
        </ul>
      </div>
      
    </div>
  </div>
  <hr />
  <div class="container">
    <div class="row text-left">
      <div class="col-md-4">
        <a id="theme" href="https://github.com/hossainemruz/toha" target="#">
          <img src="/assets/images/inverted-logo.png">
          Toha
        </a>
      </div>
      <div class="col-md-4 text-center">© 2020 Copyright.</div>
      <div class="col-md-4 text-right">
        <a id="hugo" href="https://gohugo.io/">Powered by Hugo
        <img
          src="/assets/images/hugo-logo-wide.svg"
          alt="Hugo Logo"
          height="18"
        />
        </a>
      </div>
    </div>
  </div>
</footer>

    <script src="/assets/js/jquery-3.4.1.min.js"></script>
<script src="/assets/js/bootstrap.min.js"></script>

<script src="/assets/js/navbar.js"></script>
<script src="/assets/js/main.js"></script>


    
    
<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.18.1/highlight.min.js"></script>
<script src="/assets/js/single.js"></script>
<script>
  hljs.initHighlightingOnLoad();
</script>


  </body>
</html>
